# 参考项目技术借鉴

记录各开源项目的技术借鉴点，为项目开发提供参考。

**维护说明**：每次调研新的参考项目时，应更新本文档。

---

## Magicraft_Autocontrol

**项目链接**：https://github.com/Turing-Project/Magicraft_Autocontrol

**项目简介**：基于计算机视觉和AI的2D游戏自动化系统（Magicraft游戏）

**核心特性**：实时检测、法术构建、门选择、自动攻击/闪避

---

### 可借鉴技术

#### 优先级1：立即可用 ⭐⭐⭐

**1. 控制线程架构**
- **文件**：`control_thread.py`
- **核心思想**：独立线程处理鼠标/键盘输入，避免阻塞主循环
- **关键特性**：
  - 指令队列系统（FIFO先进先出）
  - 队列长度限制（10个指令，防止堆积）
  - 高速处理模式（5ms间隔）
  - 使用 `pydirectinput` 替代 `pyautogui`（游戏专用输入库）
- **适用性**：✅ 完全适用，无需修改
- **复杂度**：⭐⭐ 中等
- **预估工作量**：0.5-1天

**实施要点**：
- 创建独立线程，循环处理指令队列
- 队列限制防止指令堆积（影响实时性）
- pydirectinput 更适合游戏输入（directx级别）

**2. 日志系统**
- **文件**：`utils/logger.py`
- **核心功能**：
  - 文件+控制台双输出日志
  - 自动创建日志目录
  - 时间戳命名日志文件（格式：`project_YYYYMMDD_HHMMSS.log`）
  - 支持4种日志级别（info/warning/error/debug）
- **适用性**：✅ 完全适用，直接复用
- **复杂度**：⭐ 简单
- **预估工作量**：0.5天

**实施要点**：
- logging.basicConfig 配置双输出
- 时间戳命名便于日志管理和追溯
- 区分日志级别便于调试和问题排查

**3. 路径管理系统**
- **文件**：`utils/paths.py`
- **核心功能**：
  - 统一管理项目路径（避免硬编码）
  - 自动创建所需目录
  - 使用 pathlib 进行路径操作
- **路径常量**：
  - PROJECT_ROOT（项目根目录）
  - DATA_DIR（数据目录）
  - MODEL_DIR（模型目录）
  - LOGS_DIR（日志目录）
  - CHECKPOINT_DIR（检查点目录）
  - CAPTURE_DIR（截图目录）
  - OUTPUT_DIR（输出目录）
- **适用性**：✅ 完全适用，直接复用
- **复杂度**：⭐ 简单
- **预估工作量**：0.5天

**实施要点**：
- 所有模块统一从 paths.py 导入路径
- 启动时自动创建所有目录
- 使用相对路径，便于项目迁移

---

#### 优先级2：需要适配 ⭐⭐

**4. 自动攻击逻辑**
- **文件**：`auto_attack.py`
- **核心算法**：
  - 距离计算：优先攻击最近的目标
  - 动态瞄准：目标框中心偏下20%（瞄准要害）
  - 队列管理：限制10个指令，实时更新
  - 结合控制线程，每帧更新鼠标位置
- **适用性**：⚠️ 需要适配
- **复杂度**：⭐⭐⭐ 较复杂
- **预估工作量**：1-2天

**适配要点**：
- 从2D游戏适配到3D游戏（LOL）
- 从怪物攻击适配到英雄技能释放
- 考虑技能范围和冷却时间
- 目标优先级调整（英雄>小兵>防御塔）

**LOL场景应用**：
- 技能释放时的瞄准点计算（目标中心或技能范围边缘）
- 结合技能类型（指向性/非指向性）调整瞄准策略
- 实时跟踪移动目标

**5. 自动闪避逻辑**
- **文件**：`auto_dodge.py`
- **核心算法**：
  - 威胁加权计算：
    - 怪物权重 2.0
    - 子弹权重 3.0（威胁更高）
  - 距离衰减：距离越近威胁越大（weight × 1/distance）
  - 动作冷却：0.3秒防抖动
  - 多方向威胁融合计算，计算最佳逃跑方向
- **适用性**：⚠️ 需要适配
- **复杂度**：⭐⭐⭐ 较复杂
- **预估工作量**：1-2天

**适配要点**：
- 应用到LOL技能躲避场景
- 考虑技能类型（指向性/非指向性/范围技能）
- 结合游戏实际威胁（敌方英雄技能位置）
- 威胁度权重需要根据LOL实际情况调整

**LOL场景应用**：
- 检测敌方技能弹道或范围
- 计算最佳闪避方向（垂直于威胁方向）
- 考虑自身技能冷却，闪避后能反打

---

#### 优先级3：可选增强 ⭐

**6. 多模态AI集成**
- **文件**：`omni_models/`
- **核心功能**：
  - 阿里云百炼API集成（多模态大模型）
  - 图像压缩编码（1024x1024，质量85%）
  - 统一客户端管理
  - 思考模型（用于复杂推理任务）
- **用途**：
  - 用于游戏状态理解（辅助或替代纯计算机视觉）
  - 复杂决策推理
  - 图像识别增强（作为备用方案）
- **适用性**：⚠️ 可选增强
- **复杂度**：⭐⭐⭐ 复杂
- **预估工作量**：2-3天
- **注意**：需要API密钥，增加外部依赖和成本

**实施要点**：
- 仅在纯计算机视觉无法准确识别时使用
- 作为辅助决策，而非主要方案
- 考虑API调用延迟和成本

**LOL场景应用**：
- 复杂场景理解（团战、兵线状态）
- 策略分析（何时团战、何时撤退）
- 作为降级方案（YOLO识别失败时启用）

---

### 技术对比

| 功能模块 | 原有方案 | Magicraft方案 | 建议操作 |
|---------|---------|---------------|---------|
| **输入模拟** | pyautogui（骨架） | pydirectinput + 控制线程 | ✅ 采用新方案 |
| **日志系统** | 无 | 文件+控制台双输出 | ✅ 采用新方案 |
| **路径管理** | 硬编码 | 统一路径管理 | ✅ 采用新方案 |
| **窗口捕获** | 未实现（骨架） | Win32 API | ✅ 借鉴思路 |
| **自动攻击** | 未实现 | 距离优先+动态瞄准 | ⚠️ 适配后采用 |
| **自动闪避** | 未实现 | 威胁加权+距离衰减 | ⚠️ 适配后采用 |
| **AI决策** | 纯深度学习 | 多模态AI | ⚠️ 可选增强 |
| **坐标系统** | 未实现 | 窗口坐标→屏幕坐标 | ✅ 借鉴思路 |

---

### 实施建议

#### 立即实施（阶段3前，不依赖其他模块）

1. **✅ 控制线程**（`backend/utils/control_thread.py`）
   - 优先级：最高
   - 前置条件：安装 pydirectinput
   - 影响：替换 `input_simulator.py` 的实现

2. **✅ 日志系统**（`backend/utils/logger.py`）
   - 优先级：高
   - 前置条件：无
   - 影响：所有模块添加日志记录

3. **✅ 路径管理**（`backend/utils/paths.py`）
   - 优先级：高
   - 前置条件：无
   - 影响：替换所有硬编码路径

#### 阶段5实施（操作执行器开发时）

4. **⚠️ 自动攻击逻辑**（适配LOL）
   - 优先级：中
   - 前置条件：游戏状态识别完成
   - 影响：技能释放准确度提升

5. **⚠️ 自动闪避逻辑**（适配LOL）
   - 优先级：中
   - 前置条件：技能检测完成
   - 影响：生存能力提升

#### 阶段6+可选（后期优化）

6. **💡 多模态AI集成**
   - 优先级：低
   - 前置条件：基础功能完成
   - 影响：复杂场景理解能力提升

---

### 关键代码思路

#### 控制线程架构思路

```
1. 初始化：
   - 创建指令队列 control_queue = []
   - 设置 pydirectinput.PAUSE = 0.01（降低延迟）
   - 设置 pyautogui.PAUSE = 0.01

2. 启动线程：
   - 创建独立线程 daemon=True
   - 线程主循环：
     while running:
       if queue not empty:
         pop cmd and execute
       sleep(5ms)

3. 指令管理：
   - add_command(type, **kwargs)
   - 队列长度限制（max 10）
   - 超过限制时丢弃旧指令

4. 停止线程：
   - 设置 running = False
   - join(timeout 1s)
```

#### 自动攻击逻辑思路

```
1. 目标选择：
   - 计算所有目标到主角的距离
   - 选择距离最近的目标
   - 如果无主角位置，选择置信度最高的

2. 瞄准点计算：
   - 目标边界框：bbox = (x1, y1, x2, y2)
   - 框高度：height = y2 - y1
   - 偏移量：offset = height × 20%（向下偏移）
   - 瞄准点：(center_x, center_y + offset)

3. 坐标转换：
   - 加上窗口偏移：window_offset_x, window_offset_y
   - 全局坐标：(target_x + offset_x, target_y + offset_y + aim_offset)

4. 指令发送：
   - 添加鼠标移动指令
   - 添加攻击按键指令
   - 队列长度 < 10 时才添加（防止堆积）
```

#### 自动闪避逻辑思路

```
1. 威胁识别：
   - 检测怪物/子弹位置
   - 计算距离和方向向量

2. 威胁加权：
   - 怪物权重：2.0
   - 子弹权重：3.0（威胁更高）
   - 距离衰减：weight × (1.0 / distance)
   - 近距离威胁权重更大

3. 逃跑方向计算：
   - 所有威胁向量加权求和（带负号）
   - escape_x -= threat_dx × weight
   - escape_y -= threat_dy × weight

4. 方向决策：
   - 比较escape_x和escape_y的绝对值
   - 选择更大的方向（水平或垂直）
   - 根据正负值决定 WASD 按键

5. 动作执行：
   - 添加按键指令到队列
   - 按键持续时间：0.15秒
   - 动作冷却：0.3秒（防抖动）
```

---

### 注意事项

#### 1. 游戏差异

**2D vs 3D**：
- Magicraft是2D游戏，LOL是3D游戏
- 坐标系统不同（需要适配）
- 操作复杂度更高（LOL有更多维度的移动和技能）

**适配策略**：
- 保持控制线程和日志系统的通用性
- 攻击/闪避逻辑需要重写核心算法
- 坐标转换需要考虑3D空间到2D屏幕的投影

#### 2. 依赖管理

**新增依赖**：
- `pydirectinput>=1.0.4`：游戏专用输入库（仅Windows）
- `python-dotenv>=1.0.0`：环境变量管理（可选，用于API密钥）

**API密钥**（多模态AI）：
- 需要阿里云百炼API密钥
- 需要更新 `.env` 文件
- 考虑调用成本和延迟

**更新 requirements.txt**：
```txt
pydirectinput>=1.0.4
python-dotenv>=1.0.0  # 可选
```

#### 3. 性能考虑

**控制线程**：
- 循环间隔：5ms（可能需要根据实际情况调整）
- 队列长度：10个指令（防止堆积，实时更新）
- 指令执行时间：每个指令 < 1ms

**自动攻击**：
- 距离计算：每帧计算所有目标距离
- 队列管理：每帧更新鼠标位置（持续跟踪）

**自动闪避**：
- 威胁识别：每帧扫描威胁
- 动作冷却：0.3秒（避免频繁操作）

#### 4. 防检测

**控制线程风险**：
- 独立线程可能触发检测（过于精确）
- 需要结合 `human_behavior.py` 的随机延迟
- 建议添加随机抖动（±5ms）

**人类行为模拟**：
- APM控制：150-250（保持与原方案一致）
- 操作延迟：200-600ms（在控制线程基础上添加）
- 偶尔"失误"：空技能、走位失误
- 定期"休息"：暂停操作1-3秒

**队列随机化**：
- 队列长度限制可以略微随机（8-12个）
- 指令执行间隔可以略微随机（±5ms）

#### 5. 测试建议

**测试顺序**：
1. 测试日志系统（文件和控制台输出）
2. 测试路径系统（目录创建）
3. 测试控制线程（队列管理、延迟）
4. 测试输入模拟器（鼠标移动、按键）
5. 测试自动攻击（目标选择、瞄准点）
6. 测试自动闪避（威胁计算、方向决策）

**验证点**：
- ✓ 日志文件自动创建并记录
- ✓ 所有目录自动创建
- ✓ 控制线程独立运行不阻塞主循环
- ✓ 指令队列不超过限制
- ✓ 鼠标/键盘输入正常
- ✓ 攻击/闪避逻辑符合预期

---

### 相关文档

- [架构设计](architecture.md) - 详细的技术架构和模块说明
- [设计提案](design_proposal.md) - 整体设计和实施计划
- [防检测策略](anti_detection.md) - 完整的防检测实施方案
- [模块API参考](api_reference.md) - 代码接口和实现细节

---

## 其他参考项目

### TLoL

**项目链接**：https://github.com/MiscellaneousStuff/tlol

**项目简介**：英雄联盟深度学习AI框架

**核心特性**：
- 833场挑战者对局数据集
- 完整的录像解析和数据处理流程
- 基于深度学习的游戏AI框架

**待调研内容**：
- [ ] 数据处理流程
- [ ] 模型架构设计
- [ ] 训练策略
- [ ] 实时游戏识别

---

### LeagueAI

**项目链接**：https://github.com/Oleffa/LeagueAI

**项目简介**：图像识别框架

**核心特性**：
- OpenCV + PyTorch 的图像识别方案
- 实时游戏状态识别
- 目标检测和OCR识别集成

**待调研内容**：
- [ ] 图像识别流程
- [ ] 目标检测模型选择
- [ ] OCR识别方案
- [ ] 性能优化技巧

---

**文档版本**: 1.0
**创建日期**: 2026-01-20
**最后更新**: 2026-01-20
**维护人员**: 项目团队
